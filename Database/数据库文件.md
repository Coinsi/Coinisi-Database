### 1. 数据库部分



- 用户表（User）：存储用户的基本信息，如用户名、密码、邮箱、电话、地址等。

- 产品表（Product）：存储产品的基本信息，如产品名、描述、价格、库存、图片等。

- 订单表（Order）：存储订单的基本信息，如订单号、用户ID、订单状态、总金额、下单时间等。

- 订单明细表（OrderDetail）：存储订单中每个产品的信息，如订单号、产品ID、数量、单价等。

- 支付表（Payment）：存储支付的基本信息，如支付号、订单号、支付方式、支付状态、支付时间等。

```sql
-- 选择数据库

USE online_shop;

-- 创建用户表

CREATE TABLE `User` (

  id INT(11) PRIMARY KEY AUTO_INCREMENT,

  username VARCHAR(50) NOT NULL UNIQUE,

  PASSWORD VARCHAR(50) NOT NULL,

  email VARCHAR(50) NOT NULL UNIQUE,

  phone VARCHAR(20),

  address VARCHAR(100)

);

-- 创建产品表

CREATE TABLE `Product` (

  id INT(11) PRIMARY KEY AUTO_INCREMENT,

  NAME VARCHAR(50) NOT NULL,

  description VARCHAR(200),

  price DECIMAL(10,2) NOT NULL,

  stock INT NOT NULL,

  image VARCHAR(100)

);

-- 创建订单表

CREATE TABLE `Order` (

  id INT(11) PRIMARY KEY AUTO_INCREMENT,

  user_id INT NOT NULL,

  orderstatus VARCHAR(20) NOT NULL,

  total DECIMAL(10,2) NOT NULL,

  order_time DATETIME NOT NULL,

  FOREIGN KEY (user_id) REFERENCES `User`(id)

);

-- 创建订单明细表

CREATE TABLE `OrderDetail` (

  order_id INT NOT NULL,

  product_id INT NOT NULL,

  quantity INT NOT NULL,

  price DECIMAL(10,2) NOT NULL,

  PRIMARY KEY (order_id, product_id),

  FOREIGN KEY (order_id) REFERENCES `Order`(id),

  FOREIGN KEY (product_id) REFERENCES `Product`(id)

);

-- 创建支付表

CREATE TABLE `Payment` (

  id INT(11) PRIMARY KEY AUTO_INCREMENT,

  order_id INT NOT NULL UNIQUE,

  method VARCHAR(20) NOT NULL,

  STATUS VARCHAR(20) NOT NULL,

  payment_time DATETIME NOT NULL,

  FOREIGN KEY (order_id) REFERENCES `Order`(id)

);
-- 创建购物车表
CREATE TABLE cart (
                      id INT(11) PRIMARY KEY AUTO_INCREMENT,
                      user_id INT(11) NOT NULL,
                      product_id INT(11) NOT NULL,
                      quantity INT NOT NULL,
                      FOREIGN KEY (user_id) REFERENCES `User`(id),
                      FOREIGN KEY (product_id) REFERENCES `Product`(id)
);
```


```sql
-- 创建一个插入订单表的触发器
CREATE TRIGGER insert_order AFTER INSERT ON cart FOR EACH ROW
INSERT INTO `Order` (id, user_id, orderstatus, total, order_time) VALUES
(generate_order_id(), NEW.user_id, '待付款', NEW.quantity * (SELECT price FROM Product WHERE id = NEW.product_id), NOW());

-- 创建一个插入订单明细表的触发器
CREATE TRIGGER insert_order_detail AFTER INSERT ON cart FOR EACH ROW
INSERT INTO OrderDetail (order_id, product_id, quantity, price) VALUES
(generate_order_id(), NEW.product_id, NEW.quantity, (SELECT price FROM Product WHERE id = NEW.product_id));

-- 创建一个插入支付表的触发器
CREATE TRIGGER insert_payment AFTER INSERT ON cart FOR EACH ROW
INSERT INTO Payment (order_id, method, status, payment_time) VALUES
(generate_order_id(), '在线支付', '待支付', NOW());
```


```sql
-- 当删除用户时，同时删除该用户的所有订单、订单明细、支付和物流信息

CREATE TRIGGER delete_user

AFTER DELETE ON `User`

FOR EACH ROW

BEGIN

  DELETE FROM `Order` WHERE user_id = OLD.id;

  DELETE FROM `OrderDetail` WHERE order_id IN (SELECT id FROM `Order` WHERE user_id = OLD.id);

  DELETE FROM `Payment` WHERE order_id IN (SELECT id FROM `Order` WHERE user_id = OLD.id);

  DELETE FROM `Shipping` WHERE order_id IN (SELECT id FROM `Order` WHERE user_id = OLD.id);

END;

-- 当删除产品时，同时删除该产品的所有订单明细信息

CREATE TRIGGER delete_product

AFTER DELETE ON `Product`

FOR EACH ROW

BEGIN

  DELETE FROM `OrderDetail` WHERE product_id = OLD.id;

END;

-- 当删除订单时，同时删除该订单的所有订单明细、支付表

CREATE TRIGGER delete_order

AFTER DELETE ON `Order`

FOR EACH ROW

BEGIN

  DELETE FROM `OrderDetail` WHERE order_id = OLD.id;

  DELETE FROM `Payment` WHERE order_id = OLD.id;

END;
```



使用sql server创建表

```sql

-- 选择数据库

USE online_shop;

-- 创建用户表

CREATE TABLE [User] (

  id INT PRIMARY KEY IDENTITY(1,1),

  username NVARCHAR(50) NOT NULL UNIQUE,

  password NVARCHAR(50) NOT NULL,

  email NVARCHAR(50) NOT NULL UNIQUE,

  phone NVARCHAR(20),

  address NVARCHAR(100)

);

-- 创建产品表

CREATE TABLE Product (

  id INT PRIMARY KEY IDENTITY(1,1),

  name NVARCHAR(50) NOT NULL,

  description NVARCHAR(200),

  price DECIMAL(10,2) NOT NULL,

  stock INT NOT NULL,

  image NVARCHAR(100)

);

-- 创建订单表

CREATE TABLE [Order] (

  id INT PRIMARY KEY IDENTITY(1,1),

  user_id INT NOT NULL,

  orderstatus NVARCHAR(20) NOT NULL,

  total DECIMAL(10,2) NOT NULL,

  order_time DATETIME2 NOT NULL,

  FOREIGN KEY (user_id) REFERENCES [User](id)

);

-- 创建订单明细表

CREATE TABLE OrderDetail (

  order_id INT NOT NULL,

  product_id INT NOT NULL,

  quantity INT NOT NULL,

  price DECIMAL(10,2) NOT NULL,

  PRIMARY KEY (order_id, product_id),

  FOREIGN KEY (order_id) REFERENCES [Order](id),

  FOREIGN KEY (product_id) REFERENCES Product(id)

);

-- 创建支付表

CREATE TABLE Payment (

  id INT PRIMARY KEY IDENTITY(1,1),

  order_id INT NOT NULL UNIQUE,

  method NVARCHAR(20) NOT NULL,

  status NVARCHAR(20) NOT NULL,

  payment_time DATETIME2 NOT NULL,

  FOREIGN KEY (order_id) REFERENCES [Order](id)

);
```
